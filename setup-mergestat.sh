#!/bin/bash

# Function to check if a command exists
command_exists() {
  command -v "$@" > /dev/null 2>&1
}

# Function to install a package if it's not installed
ensure_package_installed() {
  PACKAGE=$1
  if command_exists $PACKAGE; then
    whiptail --title "Package check" --msgbox "$PACKAGE is already installed." 8 78
  else
    if (whiptail --title "Package installation" --yesno "$PACKAGE is not installed. Do you want to install it?" 8 78); then
      sudo apt-get update && sudo apt-get install -y $PACKAGE
      whiptail --title "Package installation" --msgbox "$PACKAGE has been installed." 8 78
    else
      whiptail --title "Package installation" --msgbox "Installation of $PACKAGE has been skipped. Exiting script." 8 78
      exit 1
    fi
  fi
}

# Ensure git, curl, docker, docker-compose, and whiptail are installed
ensure_package_installed git
ensure_package_installed curl
ensure_package_installed docker
ensure_package_installed docker-compose
ensure_package_installed whiptail

REPO_URL="https://github.com/mergestat/mergestat.git"
REPO_DIR="mergestat"

# Clone mergestat repository
if [ -d "$REPO_DIR" ]; then
  whiptail --title "Git Clone" --msgbox "The directory $REPO_DIR already exists. Skipping clone." 8 78
else
  if git clone $REPO_URL; then
    whiptail --title "Git Clone" --msgbox "Successfully cloned $REPO_URL" 8 78
  else
    whiptail --title "Git Clone" --msgbox "Failed to clone $REPO_URL. Check your git configuration." 8 78
    exit 1
  fi
fi

# Change directory to the cloned repository
cd $REPO_DIR || exit

# Docker compose up
if command_exists docker-compose; then
  if whiptail --title "Docker Compose" --yesno "Would you like to run docker-compose up now?" 8 78; then
    sudo docker-compose up
  else
    whiptail --title "Docker Compose" --msgbox "docker-compose up has been skipped." 8 78
  fi
else
  whiptail --title "Docker Compose" --msgbox "docker-compose is not installed. Exiting." 8 78
  exit 1
fi
