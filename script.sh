#!/bin/bash

# Set the script to exit immediately on error
set -eo pipefail

# Array of images to scan
IMAGES=("ubuntu:latest" "alpine:latest")

# Directory to store the JSON reports
REPORT_DIR="./grype-reports"
mkdir -p "${REPORT_DIR}"

# Function to scan an image and save the report
scan_image() {
  local image="$1"
  echo "Scanning image: ${image}"

  # Generate a filename based on the image name
  local filename=$(echo "${image}" | tr '/:' '__')
  local report_path="${REPORT_DIR}/${filename}.json"

  # Scan the image with Grype and save the output to a JSON file
  grype "${image}" -o json > "${report_path}"
  echo "Report saved to: ${report_path}"
}

# Randomly select two images from the array
RANDOM_IMAGE_1=${IMAGES[$RANDOM % ${#IMAGES[@]}]}
RANDOM_IMAGE_2=${IMAGES[$RANDOM % ${#IMAGES[@]}]}

# Ensure that we have two distinct images to scan
while [ "$RANDOM_IMAGE_1" == "$RANDOM_IMAGE_2" ]; do
  RANDOM_IMAGE_2=${IMAGES[$RANDOM % ${#IMAGES[@]}]}
done

# Scan the selected images
scan_image "${RANDOM_IMAGE_1}"
scan_image "${RANDOM_IMAGE_2}"

echo "Scanning complete."
