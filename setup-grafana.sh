#!/bin/bash

# Script to automatically install Grafana based on the operating system.
# Supports Ubuntu, Debian (including Kali Linux as Debian), Red Hat, CentOS, RHEL, Fedora, OpenSUSE, and SUSE.
# Usage:
#   - For interactive mode: ./grafana_setup.sh
#   - For automatic mode (no prompts): ./grafana_setup.sh --auto

# Define Grafana version and package URLs along with their SHA256 checksums for validation
GRAFANA_DEB="https://dl.grafana.com/oss/release/grafana_10.4.0_amd64.deb"
GRAFANA_DEB_SHA256="9b3bd908b69d4a93c426c20d8a0f3e8b6d3b433b3a9aaa2e86ddbefa4c6da4e1"
GRAFANA_RPM="https://dl.grafana.com/oss/release/grafana-10.4.0-1.x86_64.rpm"
GRAFANA_RPM_SHA256="3711f9924202601814f8cd9f1c7cb9ea35695de3fd4f2b1ed8a8c90cc31acf31"

# Detects the operating system and version.
detect_os() {
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$NAME
    VER=$VERSION_ID
  elif type lsb_release >/dev/null 2>&1; then
    OS=$(lsb_release -si)
    VER=$(lsb_release -sr)
  elif [ -f /etc/lsb-release ]; then
    . /etc/lsb-release
    OS=$DISTRIB_ID
    VER=$DISTRIB_RELEASE
  elif [ -f /etc/debian_version ]; then
    OS=Debian
    VER=$(cat /etc/debian_version)
  else
    OS=$(uname -s)
    VER=$(uname -r)
  fi

  # Treat "Kali GNU/Linux" as Debian
  if [[ "$OS" == "Kali Linux" ]] || [[ "$OS" == "Kali GNU/Linux" ]]; then
    OS="Debian"
  fi
}

# Downloads and validates the SHA256 checksum of the provided file URL.
download_and_validate() {
  URL=$1
  EXPECTED_SHA256=$2
  FILE=$(basename "$URL")

  echo "Downloading $FILE..."
  wget -q "$URL" -O "$FILE"

  echo "Validating the SHA256 checksum..."
  SHA256=$(sha256sum "$FILE" | awk '{print $1}')
  if [ "$EXPECTED_SHA256" != "$SHA256" ]; then
    echo "ERROR: SHA256 checksum does not match!"
    exit 1
  fi

  echo "$FILE downloaded and validated successfully."
}

# Installation process for Debian/Ubuntu systems.
install_debian() {
  sudo apt-get update
  sudo apt-get install -y adduser libfontconfig1 musl
  download_and_validate "$GRAFANA_DEB" "$GRAFANA_DEB_SHA256"
  sudo dpkg -i $(basename "$GRAFANA_DEB")
}

# Installation process for Red Hat/CentOS/Fedora systems.
install_rhel() {
  sudo yum install -y "$GRAFANA_RPM"
}

# Installation process for OpenSUSE/SUSE systems.
install_suse() {
  download_and_validate "$GRAFANA_RPM" "$GRAFANA_RPM_SHA256"
  sudo rpm -Uvh $(basename "$GRAFANA_RPM")
}

# Main installation function that selects the correct installation procedure based on the OS.
install_grafana() {
  detect_os

  case $OS in
    "Ubuntu"|"Debian")
      install_debian
      ;;
    "Fedora"|"CentOS Linux"|"Red Hat Enterprise Linux")
      install_rhel
      ;;
    "openSUSE Leap"|"SUSE")
      install_suse
      ;;
    *)
      echo "Unsupported operating system: $OS"
      exit 1
      ;;
  esac

  echo "Grafana installation completed successfully."
}

# Checks if the script is running in interactive mode or automatic mode.
INTERACTIVE=1
if [ "$1" == "--auto" ]; then
  INTERACTIVE=0
fi

# In interactive mode, prompt the user before proceeding with
# the installation. In automatic mode, proceed without prompting.
if [ $INTERACTIVE -eq 1 ]; then
  echo "This script will install Grafana on your system."
  read -p "Do you want to continue? (y/n) " -n 1 -r
  echo    # Move to a new line
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    install_grafana
  else
    echo "Installation aborted by the user."
    exit 1
  fi
else
  install_grafana
fi
